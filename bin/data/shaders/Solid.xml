<?xml version="1.0"?>
<shader priority="1">
    <input>
        <position bind="float3" semantic="POSITION" />
        <texCoord bind="float2" semantic="TEXCOORD" />
        <tangent bind="float3" semantic="TANGENT" />
        <biTangent bind="float3" semantic="BITANGENT" />
        <normal bind="float3" semantic="NORMAL" />
        <isFrontFacing system="isFrontFacing" />
    </input>

    <lighting>
        <lightsPerPass>255</lightsPerPass>
    </lighting>

    <material>
        <solid>
            <albedo bind="float4" pattern="system" parameters="debug">Texture2D</albedo>
            <normal bind="float2" pattern="system" parameters="flat">Texture2D</normal>
            <roughness bind="float" pattern="color" parameters=".5">Texture2D</roughness>
            <metallic bind="float" pattern="color" parameters="0">Texture2D</metallic>
        </solid>
    </material>

    <defines>
        <tileSize>32</tileSize>
        <dispatchWidth>ceil(displayWidth / tileSize)</dispatchWidth>
        <dispatchHeight>ceil(displayHeight / tileSize)</dispatchHeight>
        <gaussianRadius bind="int">2</gaussianRadius>
        <gaussianSigma>2.3</gaussianSigma>
        <edgeSharpness>0.1</edgeSharpness>
    </defines>

    <textures>
        <depthBuffer bind="float" flags="depth">D32_FLOAT</depthBuffer>
        <albedoBuffer bind="float3" flags="target">R11G11B10_FLOAT</albedoBuffer>
        <materialBuffer bind="float2" flags="target">R8G8_UNORM</materialBuffer>
        <normalBuffer bind="float2" flags="target">R8G8_NORM</normalBuffer>
        <ambientBuffer bind="float" flags="target">R8_UNORM</ambientBuffer>
        <gaussianBuffer bind="float" flags="target">R8_UNORM</gaussianBuffer>
    </textures>

    <buffers>
        <tileIndexList size="dispatchWidth * dispatchHeight * (lightsPerPass + 1)" flags="unorderedAccess">R8_UINT</tileIndexList>
    </buffers>

    <blocks>
        <DeferredPass>
            <passes>
                <StoreDeferred forward="solid" entry="mainPixelProgram">
                    <depthstates target="depthBuffer">
                        <comparison>less_equal</comparison>
                        <writemask>all</writemask>
                        <clear>1</clear>
                    </depthstates>

                    <renderstates>
                        <cullmode>back</cullmode>
                    </renderstates>

                    <targets>
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                    </targets>
                </StoreDeferred>
            </passes>
        </DeferredPass>

        <AmbientPass>
            <passes>
                <AmbientCalculation entry="mainPixelProgram">
                    <defines>
                        <radius>2</radius>
                        <tapCount bind="uint">24</tapCount>
                        <spiralTurns>13</spiralTurns>
                        <intensity>20</intensity>
                        <bias>0.08</bias>
                        <falloffFunction bind="uint">0</falloffFunction>
                        <epsilon>0.001</epsilon>
                    </defines>

                    <resources>
                        <normalBuffer />
                        <depthBuffer />
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>
                </AmbientCalculation>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis bind="int2">(1,0)</blurAxis>
                    </defines>

                    <resources>
                        <depthBuffer />
                        <ambientBuffer>inputBuffer</ambientBuffer>
                    </resources>

                    <targets>
                        <gaussianBuffer />
                    </targets>
                </AmbientBlur>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis bind="int2">(1,0)</blurAxis>
                    </defines>

                    <resources>
                        <depthBuffer />
                        <gaussianBuffer>inputBuffer</gaussianBuffer>
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>
                </AmbientBlur>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis bind="int2">(0,1)</blurAxis>
                    </defines>

                    <resources>
                        <depthBuffer />
                        <ambientBuffer>inputBuffer</ambientBuffer>
                    </resources>

                    <targets>
                        <gaussianBuffer />
                    </targets>
                </AmbientBlur>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis bind="int2">(0,1)</blurAxis>
                    </defines>

                    <resources>
                        <depthBuffer />
                        <gaussianBuffer>inputBuffer</gaussianBuffer>
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>
                </AmbientBlur>

                <AmbientLighting entry="mainPixelProgram">
                    <resources>
                        <albedoBuffer />
                        <ambientBuffer />
                        <depthBuffer />
                    </resources>

                    <targets>
                        <screen />
                    </targets>
                </AmbientLighting>
            </passes>
        </AmbientPass>

        <LightingPass lighting="true">
            <passes>
                <TiledLightCulling compute="(dispatchWidth, dispatchHeight, 1)" entry="mainComputeProgram">
                    <resources>
                        <depthBuffer />
                    </resources>

                    <unorderedaccess>
                        <tileIndexList />
                    </unorderedaccess>
                </TiledLightCulling>

                <AccumulateLighting entry="mainPixelProgram">
                    <defines>
                        <useHalfLambert bind="bool">true</useHalfLambert>
                    </defines>

                    <blendstates unified="true">
                        <color source="one" destination="one" operation="add" />
                    </blendstates>

                    <resources>
                        <tileIndexList />
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                        <depthBuffer />
                    </resources>

                    <targets>
                        <screen />
                    </targets>
                </AccumulateLighting>
            </passes>
        </LightingPass>
    </blocks>
</shader>
